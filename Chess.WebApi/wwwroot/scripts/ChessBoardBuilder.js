import { DomManipulator } from './DomManipulator.js';
import { Square } from './Square.js';
var a = 'A';
var h = 'H';
var table = 'table';
var th = 'th';
var tr = 'tr';
var td = 'td';
var tc = 'tc';
var id = 'id';
var selected = 'selected';
var InitialState = [
    ['♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜'],
    ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
    ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
];
var State = [
    ['♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜'],
    ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
    ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
];
var ChessBoardBuilder = /** @class */ (function () {
    function ChessBoardBuilder() {
        this.domManipulator = new DomManipulator();
        this.moveFrom = null;
        this.whiteOnTopWhenShow = false;
        this.showChessBoard();
    }
    ChessBoardBuilder.prototype.createChessBoard = function () {
        var body = document.getElementsByTagName('body')[0];
        var board = this.domManipulator.createElement(table, body);
        board === null || board === void 0 ? void 0 : board.setAttribute('class', 'chess-board');
        var tableBody = this.domManipulator.createElement('tbody', board);
        this.createTableColumns(tableBody);
        this.createSquares(tableBody);
    };
    ChessBoardBuilder.prototype.createTableColumns = function (tableBody) {
        var header = this.domManipulator.createElement(tr, tableBody);
        this.domManipulator.createElement(th, header);
        for (var columnIndex = 0; columnIndex < 8; columnIndex++) {
            this.createTableHeaderCell(header, tc + columnIndex + 1, this.getColumnText(columnIndex));
        }
    };
    ChessBoardBuilder.prototype.createTableHeaderCell = function (parent, idValue, text) {
        var header = this.domManipulator.createElement(th, parent);
        header.setAttribute(id, idValue);
        header.textContent = text;
    };
    ChessBoardBuilder.prototype.createTableRank = function (tableBody, rankNumber) {
        var rank = this.domManipulator.createElement(tr, tableBody);
        this.createTableHeaderCell(rank, tr + rankNumber, rankNumber.toString());
        return rank;
    };
    ChessBoardBuilder.prototype.createSquares = function (tableBody) {
        for (var rankIndex = 0; rankIndex < 8; rankIndex++) {
            var rankNumber = this.whiteOnTopWhenShow ? rankIndex + 1 : 8 - rankIndex;
            var rank = this.createTableRank(tableBody, rankNumber);
            for (var columnIndex = 0; columnIndex < 8; columnIndex++) {
                var square = this.domManipulator.createElement(td, rank);
                square.setAttribute(id, this.getColumnText(columnIndex) + rankNumber);
                square.onclick = this.squareOnClick.bind(this);
                square.setAttribute('class', (rankIndex + columnIndex) % 2 == 1 ? 'dark' : 'light');
                square.textContent = this.isWhiteOnTopInStateRepresentation() ?
                    this.getState(rankNumber - 1, this.whiteOnTopWhenShow ? columnIndex : 7 - columnIndex) :
                    this.getState(this.whiteOnTopWhenShow ? 7 - rankIndex : rankIndex, this.whiteOnTopWhenShow ? 7 - columnIndex : columnIndex);
            }
        }
    };
    ChessBoardBuilder.prototype.squareOnClick = function (event) {
        var _this = this;
        if (this.moveFrom == null) {
            this.moveFrom = event.srcElement;
            this.moveFrom.classList.add(selected);
        }
        else {
            this.moveFrom.classList.remove(selected);
            var toSquare_1 = this.getSquare(event.srcElement);
            var fromSquare_1 = this.getSquare(this.moveFrom);
            var request_1 = new XMLHttpRequest();
            request_1.open('PUT', 'KnightsTale/api/game/move');
            request_1.setRequestHeader('content-type', 'application/json');
            request_1.send(JSON.stringify(this.getMove(fromSquare_1, toSquare_1)));
            request_1.onreadystatechange = function () {
                if (request_1.readyState == 4 && request_1.status == 200) {
                    _this.setState(toSquare_1.rankIndex, toSquare_1.columnIndex, _this.getState(fromSquare_1.rankIndex, fromSquare_1.columnIndex));
                    _this.setState(fromSquare_1.rankIndex, fromSquare_1.columnIndex, ' ');
                    _this.showChessBoard();
                }
            };
            this.moveFrom = null;
        }
    };
    ChessBoardBuilder.prototype.getMove = function (fromSquare, toSquare) {
        return fromSquare.toString(this.whiteOnTopWhenShow) + toSquare.toString(this.whiteOnTopWhenShow);
    };
    ChessBoardBuilder.prototype.getSquare = function (square) {
        var rank = parseInt(square.id[1]);
        var column = square.id.charCodeAt(0);
        return this.isWhiteOnTopInStateRepresentation() ?
            new Square(h.charCodeAt(0) - column, rank - 1) :
            new Square(column - a.charCodeAt(0), 8 - rank);
    };
    ChessBoardBuilder.prototype.charShift = function (ch, shift) {
        return String.fromCharCode(ch.charCodeAt(0) + shift);
    };
    ChessBoardBuilder.prototype.getColumnText = function (columnIndex) {
        return this.whiteOnTopWhenShow ? this.charShift(h, -columnIndex) : this.charShift(a, columnIndex);
    };
    ChessBoardBuilder.prototype.isWhiteOnTopInStateRepresentation = function () {
        return InitialState[0][0] == '♖';
    };
    ChessBoardBuilder.prototype.getState = function (rankIndex, columnIndex) {
        return State[rankIndex][columnIndex];
    };
    ChessBoardBuilder.prototype.setState = function (rankIndex, columnIndex, value) {
        State[rankIndex][columnIndex] = value;
    };
    ChessBoardBuilder.prototype.resetStates = function () {
        for (var rankIndex = 0; rankIndex < 8; rankIndex++) {
            State[rankIndex] = InitialState[rankIndex].map(function (x) { return x; });
        }
    };
    ChessBoardBuilder.prototype.showChessBoard = function (whiteOnTopWhenShow) {
        if (whiteOnTopWhenShow === void 0) { whiteOnTopWhenShow = undefined; }
        if (whiteOnTopWhenShow !== undefined) {
            this.whiteOnTopWhenShow = whiteOnTopWhenShow;
        }
        var board = document.getElementsByTagName(table)[0];
        if (board) {
            board.remove();
            this.moveFrom = null;
        }
        this.createChessBoard();
    };
    ChessBoardBuilder.prototype.switchSide = function () {
        this.showChessBoard(!this.whiteOnTopWhenShow);
    };
    return ChessBoardBuilder;
}());
export { ChessBoardBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hlc3NCb2FyZEJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDaGVzc0JvYXJkQnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDckQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUVyQyxJQUFNLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDZCxJQUFNLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDZCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUM7QUFDdEIsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUNoQixJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDaEIsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUNoQixJQUFNLFFBQVEsR0FBRyxVQUFVLENBQUM7QUFFNUIsSUFBTSxZQUFZLEdBQXlCO0lBQzFDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7Q0FDeEMsQ0FBQztBQUVGLElBQU0sS0FBSyxHQUF5QjtJQUNuQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcs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LEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNmLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1NBQ3JCO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVNLHNDQUFVLEdBQWpCO1FBQ0MsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFDRix3QkFBQztBQUFELENBQUMsQUExSUQsSUEwSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEb21NYW5pcHVsYXRvciB9IGZyb20gJy4vRG9tTWFuaXB1bGF0b3IuanMnO1xyXG5pbXBvcnQgeyBTcXVhcmUgfSBmcm9tICcuL1NxdWFyZS5qcyc7XHJcblxyXG5jb25zdCBhID0gJ0EnO1xyXG5jb25zdCBoID0gJ0gnO1xyXG5jb25zdCB0YWJsZSA9ICd0YWJsZSc7XHJcbmNvbnN0IHRoID0gJ3RoJztcclxuY29uc3QgdHIgPSAndHInO1xyXG5jb25zdCB0ZCA9ICd0ZCc7XHJcbmNvbnN0IHRjID0gJ3RjJztcclxuY29uc3QgaWQgPSAnaWQnO1xyXG5jb25zdCBzZWxlY3RlZCA9ICdzZWxlY3RlZCc7XHJcblxyXG5jb25zdCBJbml0aWFsU3RhdGU6IEFycmF5PEFycmF5PHN0cmluZz4+ID0gW1xyXG5cdFsn4pmcJywgJ+KZnicsICfimZ0nLCAn4pmbJywgJ+KZmicsICfimZ0nLCAn4pmeJywgJ+KZnCddLFxyXG5cdFsn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnyddLFxyXG5cdFsnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJ10sXHJcblx0WycgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJ10sXHJcblx0WyfimZknLCAn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJ10sXHJcblx0WyfimZYnLCAn4pmYJywgJ+KZlycsICfimZUnLCAn4pmUJywgJ+KZlycsICfimZgnLCAn4pmWJ11cclxuXTtcclxuXHJcbmNvbnN0IFN0YXRlOiBBcnJheTxBcnJheTxzdHJpbmc+PiA9IFtcclxuXHRbJ+KZnCcsICfimZ4nLCAn4pmdJywgJ+KZmycsICfimZonLCAn4pmdJywgJ+KZnicsICfimZwnXSxcclxuXHRbJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJ10sXHJcblx0WycgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmSddLFxyXG5cdFsn4pmWJywgJ+KZmCcsICfimZcnLCAn4pmVJywgJ+KZlCcsICfimZcnLCAn4pmYJywgJ+KZliddXHJcbl07XHJcblxyXG5leHBvcnQgY2xhc3MgQ2hlc3NCb2FyZEJ1aWxkZXIge1xyXG5cclxuXHRwcml2YXRlIGRvbU1hbmlwdWxhdG9yOiBEb21NYW5pcHVsYXRvcjtcclxuXHRwcml2YXRlIG1vdmVGcm9tOiBIVE1MRWxlbWVudCB8IG51bGw7XHJcblx0cHJpdmF0ZSB3aGl0ZU9uVG9wV2hlblNob3c6IGJvb2xlYW47XHJcblxyXG5cdHB1YmxpYyBjb25zdHJ1Y3RvcigpIHtcclxuXHRcdHRoaXMuZG9tTWFuaXB1bGF0b3IgPSBuZXcgRG9tTWFuaXB1bGF0b3IoKTtcclxuXHRcdHRoaXMubW92ZUZyb20gPSBudWxsO1xyXG5cdFx0dGhpcy53aGl0ZU9uVG9wV2hlblNob3cgPSBmYWxzZTtcclxuXHRcdHRoaXMuc2hvd0NoZXNzQm9hcmQoKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgY3JlYXRlQ2hlc3NCb2FyZCgpOiB2b2lkIHtcclxuXHRcdGNvbnN0IGJvZHk6IEhUTUxCb2R5RWxlbWVudCB8IHVuZGVmaW5lZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdib2R5JylbMF07XHJcblx0XHRjb25zdCBib2FyZDogSFRNTFRhYmxlRWxlbWVudCB8IHVuZGVmaW5lZCA9IDxIVE1MVGFibGVFbGVtZW50IHwgdW5kZWZpbmVkPnRoaXMuZG9tTWFuaXB1bGF0b3IuY3JlYXRlRWxlbWVudCh0YWJsZSwgPEhUTUxFbGVtZW50PmJvZHkpO1xyXG5cdFx0Ym9hcmQ/LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCAnY2hlc3MtYm9hcmQnKTtcclxuXHRcdGNvbnN0IHRhYmxlQm9keTogSFRNTEVsZW1lbnQgPSB0aGlzLmRvbU1hbmlwdWxhdG9yLmNyZWF0ZUVsZW1lbnQoJ3Rib2R5JywgPEhUTUxFbGVtZW50PmJvYXJkKTtcclxuXHJcblx0XHR0aGlzLmNyZWF0ZVRhYmxlQ29sdW1ucyh0YWJsZUJvZHkpO1xyXG5cdFx0dGhpcy5jcmVhdGVTcXVhcmVzKHRhYmxlQm9keSk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGNyZWF0ZVRhYmxlQ29sdW1ucyh0YWJsZUJvZHk6IEhUTUxFbGVtZW50KTogdm9pZCB7XHJcblx0XHRjb25zdCBoZWFkZXI6IEhUTUxFbGVtZW50ID0gdGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KHRyLCB0YWJsZUJvZHkpO1xyXG5cdFx0dGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KHRoLCBoZWFkZXIpO1x0XHJcblx0XHRmb3IgKGxldCBjb2x1bW5JbmRleCA9IDA7IGNvbHVtbkluZGV4IDwgODsgY29sdW1uSW5kZXgrKykge1xyXG5cdFx0XHR0aGlzLmNyZWF0ZVRhYmxlSGVhZGVyQ2VsbChoZWFkZXIsIHRjICsgY29sdW1uSW5kZXggKyAxLCB0aGlzLmdldENvbHVtblRleHQoY29sdW1uSW5kZXgpKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgY3JlYXRlVGFibGVIZWFkZXJDZWxsKHBhcmVudDogSFRNTEVsZW1lbnQsIGlkVmFsdWU6IHN0cmluZywgdGV4dDogc3RyaW5nKTogdm9pZCB7XHJcblx0XHRjb25zdCBoZWFkZXIgPSB0aGlzLmRvbU1hbmlwdWxhdG9yLmNyZWF0ZUVsZW1lbnQodGgsIHBhcmVudCk7XHJcblx0XHRoZWFkZXIuc2V0QXR0cmlidXRlKGlkLCBpZFZhbHVlKTtcclxuXHRcdGhlYWRlci50ZXh0Q29udGVudCA9IHRleHQ7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGNyZWF0ZVRhYmxlUmFuayh0YWJsZUJvZHk6IEhUTUxFbGVtZW50LCByYW5rTnVtYmVyOiBudW1iZXIpIHtcclxuXHRcdGNvbnN0IHJhbmsgPSB0aGlzLmRvbU1hbmlwdWxhdG9yLmNyZWF0ZUVsZW1lbnQodHIsIHRhYmxlQm9keSk7XHJcblx0XHR0aGlzLmNyZWF0ZVRhYmxlSGVhZGVyQ2VsbChyYW5rLCB0ciArIHJhbmtOdW1iZXIsIHJhbmtOdW1iZXIudG9TdHJpbmcoKSk7XHJcblx0XHRyZXR1cm4gcmFuaztcclxuXHR9XHJcblx0XHJcblx0cHJpdmF0ZSBjcmVhdGVTcXVhcmVzKHRhYmxlQm9keTogSFRNTEVsZW1lbnQpIHtcclxuXHRcdGZvciAobGV0IHJhbmtJbmRleCA9IDA7IHJhbmtJbmRleCA8IDg7IHJhbmtJbmRleCsrKSB7XHJcblx0XHRcdGNvbnN0IHJhbmtOdW1iZXI6IG51bWJlciA9IHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID8gcmFua0luZGV4ICsgMSA6IDggLSByYW5rSW5kZXg7XHJcblx0XHRcdGNvbnN0IHJhbmsgPSB0aGlzLmNyZWF0ZVRhYmxlUmFuayh0YWJsZUJvZHksIHJhbmtOdW1iZXIpO1xyXG5cdFx0XHRcclxuXHRcdFx0Zm9yIChsZXQgY29sdW1uSW5kZXggPSAwOyBjb2x1bW5JbmRleCA8IDg7IGNvbHVtbkluZGV4KyspIHtcclxuXHRcdFx0XHRjb25zdCBzcXVhcmUgPSB0aGlzLmRvbU1hbmlwdWxhdG9yLmNyZWF0ZUVsZW1lbnQodGQsIHJhbmspO1xyXG5cdFx0XHRcdHNxdWFyZS5zZXRBdHRyaWJ1dGUoaWQsIHRoaXMuZ2V0Q29sdW1uVGV4dChjb2x1bW5JbmRleCkgKyByYW5rTnVtYmVyKTtcclxuXHRcdFx0XHRzcXVhcmUub25jbGljayA9IHRoaXMuc3F1YXJlT25DbGljay5iaW5kKHRoaXMpO1xyXG5cdFx0XHRcdHNxdWFyZS5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgKHJhbmtJbmRleCArIGNvbHVtbkluZGV4KSAlIDIgPT0gMSA/ICdkYXJrJyA6ICdsaWdodCcpO1xyXG5cdFx0XHRcdHNxdWFyZS50ZXh0Q29udGVudCA9IHRoaXMuaXNXaGl0ZU9uVG9wSW5TdGF0ZVJlcHJlc2VudGF0aW9uKCkgP1xyXG5cdFx0XHRcdFx0dGhpcy5nZXRTdGF0ZShyYW5rTnVtYmVyIC0gMSwgdGhpcy53aGl0ZU9uVG9wV2hlblNob3cgPyBjb2x1bW5JbmRleCA6IDcgLSBjb2x1bW5JbmRleCkgOlxyXG5cdFx0XHRcdFx0dGhpcy5nZXRTdGF0ZSh0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyA/IDcgLSByYW5rSW5kZXggOiByYW5rSW5kZXgsIHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID8gNyAtIGNvbHVtbkluZGV4IDogY29sdW1uSW5kZXgpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIHNxdWFyZU9uQ2xpY2soZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuXHRcdGlmICh0aGlzLm1vdmVGcm9tID09IG51bGwpIHtcclxuXHRcdFx0dGhpcy5tb3ZlRnJvbSA9IDxIVE1MRWxlbWVudD5ldmVudC5zcmNFbGVtZW50O1xyXG5cdFx0XHR0aGlzLm1vdmVGcm9tLmNsYXNzTGlzdC5hZGQoc2VsZWN0ZWQpO1xyXG5cdFx0fSBlbHNlIHtcclxuXHRcdFx0dGhpcy5tb3ZlRnJvbS5jbGFzc0xpc3QucmVtb3ZlKHNlbGVjdGVkKTtcclxuXHRcdFx0Y29uc3QgdG9TcXVhcmU6IFNxdWFyZSA9IHRoaXMuZ2V0U3F1YXJlKDxIVE1MRWxlbWVudD5ldmVudC5zcmNFbGVtZW50KTtcclxuXHRcdFx0Y29uc3QgZnJvbVNxdWFyZTogU3F1YXJlID0gdGhpcy5nZXRTcXVhcmUodGhpcy5tb3ZlRnJvbSk7XHJcblxyXG5cdFx0XHRjb25zdCByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XHJcblx0XHRcdHJlcXVlc3Qub3BlbignUFVUJywgJ0tuaWdodHNUYWxlL2FwaS9nYW1lL21vdmUnKTtcclxuXHRcdFx0cmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdjb250ZW50LXR5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xyXG5cdFx0XHRyZXF1ZXN0LnNlbmQoSlNPTi5zdHJpbmdpZnkodGhpcy5nZXRNb3ZlKGZyb21TcXVhcmUsIHRvU3F1YXJlKSkpO1xyXG5cdFx0XHRyZXF1ZXN0Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9ICgpID0+IHtcclxuXHRcdFx0XHRpZiAocmVxdWVzdC5yZWFkeVN0YXRlID09IDQgJiYgcmVxdWVzdC5zdGF0dXMgPT0gMjAwKSB7XHJcblx0XHRcdFx0XHR0aGlzLnNldFN0YXRlKHRvU3F1YXJlLnJhbmtJbmRleCwgdG9TcXVhcmUuY29sdW1uSW5kZXgsIHRoaXMuZ2V0U3RhdGUoZnJvbVNxdWFyZS5yYW5rSW5kZXgsIGZyb21TcXVhcmUuY29sdW1uSW5kZXgpKTtcclxuXHRcdFx0XHRcdHRoaXMuc2V0U3RhdGUoZnJvbVNxdWFyZS5yYW5rSW5kZXgsIGZyb21TcXVhcmUuY29sdW1uSW5kZXgsICcgJyk7XHJcblx0XHRcdFx0XHR0aGlzLnNob3dDaGVzc0JvYXJkKCk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9O1xyXG5cdFx0XHR0aGlzLm1vdmVGcm9tID0gbnVsbDtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0TW92ZShmcm9tU3F1YXJlOiBTcXVhcmUsIHRvU3F1YXJlOiBTcXVhcmUpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIGZyb21TcXVhcmUudG9TdHJpbmcodGhpcy53aGl0ZU9uVG9wV2hlblNob3cpICsgdG9TcXVhcmUudG9TdHJpbmcodGhpcy53aGl0ZU9uVG9wV2hlblNob3cpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRTcXVhcmUoc3F1YXJlOiBIVE1MRWxlbWVudCk6IFNxdWFyZSB7XHJcblx0XHRjb25zdCByYW5rID0gcGFyc2VJbnQoPHN0cmluZz5zcXVhcmUuaWRbMV0pO1xyXG5cdFx0Y29uc3QgY29sdW1uID0gc3F1YXJlIC5pZC5jaGFyQ29kZUF0KDApO1xyXG5cdFx0cmV0dXJuIHRoaXMuaXNXaGl0ZU9uVG9wSW5TdGF0ZVJlcHJlc2VudGF0aW9uKCkgP1xyXG5cdFx0XHRuZXcgU3F1YXJlKGguY2hhckNvZGVBdCgwKSAtIGNvbHVtbiwgcmFuayAtIDEpIDpcclxuXHRcdFx0bmV3IFNxdWFyZShjb2x1bW4gLSBhLmNoYXJDb2RlQXQoMCksIDggLSByYW5rKTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgY2hhclNoaWZ0KGNoOiBzdHJpbmcsIHNoaWZ0OiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoY2guY2hhckNvZGVBdCgwKSArIHNoaWZ0KTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0Q29sdW1uVGV4dChjb2x1bW5JbmRleDogbnVtYmVyKTogc3RyaW5nIHtcclxuXHRcdHJldHVybiB0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyA/IHRoaXMuY2hhclNoaWZ0KGgsIC1jb2x1bW5JbmRleCkgOiB0aGlzLmNoYXJTaGlmdChhLCBjb2x1bW5JbmRleCk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGlzV2hpdGVPblRvcEluU3RhdGVSZXByZXNlbnRhdGlvbigpOiBib29sZWFuIHtcclxuXHRcdHJldHVybiAoPEFycmF5PHN0cmluZz4+SW5pdGlhbFN0YXRlWzBdKVswXSA9PSAn4pmWJztcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgZ2V0U3RhdGUocmFua0luZGV4OiBudW1iZXIsIGNvbHVtbkluZGV4OiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIDxzdHJpbmc+KDxBcnJheTxzdHJpbmc+PlN0YXRlW3JhbmtJbmRleF0pW2NvbHVtbkluZGV4XTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgc2V0U3RhdGUocmFua0luZGV4OiBudW1iZXIsIGNvbHVtbkluZGV4OiBudW1iZXIsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcclxuXHRcdCg8QXJyYXk8c3RyaW5nPj5TdGF0ZVtyYW5rSW5kZXhdKVtjb2x1bW5JbmRleF0gPSB2YWx1ZTtcclxuXHR9XHJcblxyXG5cdHB1YmxpYyByZXNldFN0YXRlcygpOiB2b2lkIHtcclxuXHRcdGZvciAobGV0IHJhbmtJbmRleCA9IDA7IHJhbmtJbmRleCA8IDg7IHJhbmtJbmRleCsrKSB7XHJcblx0XHRcdFN0YXRlW3JhbmtJbmRleF0gPSAoPEFycmF5PHN0cmluZz4+SW5pdGlhbFN0YXRlW3JhbmtJbmRleF0pLm1hcCgoeDogc3RyaW5nKSA9PiB4KTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHB1YmxpYyBzaG93Q2hlc3NCb2FyZCh3aGl0ZU9uVG9wV2hlblNob3c6IGJvb2xlYW4gfCB1bmRlZmluZWQgPSB1bmRlZmluZWQpOiB2b2lkIHtcclxuXHRcdGlmICh3aGl0ZU9uVG9wV2hlblNob3cgIT09IHVuZGVmaW5lZCkge1xyXG5cdFx0XHR0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyA9IHdoaXRlT25Ub3BXaGVuU2hvdztcclxuICAgICAgICB9XHJcblxyXG5cdFx0Y29uc3QgYm9hcmQ6IEhUTUxUYWJsZUVsZW1lbnQgfCB1bmRlZmluZWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWJsZSlbMF07XHJcblx0XHRpZiAoYm9hcmQpIHtcclxuXHRcdFx0Ym9hcmQucmVtb3ZlKCk7XHJcblx0XHRcdHRoaXMubW92ZUZyb20gPSBudWxsO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5jcmVhdGVDaGVzc0JvYXJkKCk7XHJcblx0fVxyXG5cdFxyXG5cdHB1YmxpYyBzd2l0Y2hTaWRlKCk6IHZvaWQge1xyXG5cdFx0dGhpcy5zaG93Q2hlc3NCb2FyZCghdGhpcy53aGl0ZU9uVG9wV2hlblNob3cpO1xyXG5cdH1cclxufSJdfQ==