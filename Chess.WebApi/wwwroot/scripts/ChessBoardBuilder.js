import { DomManipulator } from './DomManipulator.js';
import { RequestCallbacksDto } from './Dtos/RequestCallbacksDto.js';
import { RequestSender } from './RequestSender.js';
import { Square } from './Square.js';
var a = 'A';
var h = 'H';
var table = 'table';
var th = 'th';
var tr = 'tr';
var td = 'td';
var tc = 'tc';
var id = 'id';
var selected = 'selected';
var InitialState = [
    ['♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜'],
    ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
    ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
];
var State = [
    ['♜', '♞', '♝', '♛', '♚', '♝', '♞', '♜'],
    ['♟', '♟', '♟', '♟', '♟', '♟', '♟', '♟'],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    [' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '],
    ['♙', '♙', '♙', '♙', '♙', '♙', '♙', '♙'],
    ['♖', '♘', '♗', '♕', '♔', '♗', '♘', '♖']
];
var ChessBoardBuilder = /** @class */ (function () {
    function ChessBoardBuilder(chessGame) {
        this.chessGame = chessGame;
        this.domManipulator = new DomManipulator();
        this.moveFrom = null;
        this.whiteOnTopWhenShow = false;
        this.showChessBoard();
    }
    ChessBoardBuilder.prototype.createChessBoard = function () {
        var body = document.getElementsByTagName('body')[0];
        var board = this.domManipulator.createElement(table, body);
        board === null || board === void 0 ? void 0 : board.setAttribute('class', 'chess-board');
        var tableBody = this.domManipulator.createElement('tbody', board);
        this.createTableColumns(tableBody);
        this.createSquares(tableBody);
    };
    ChessBoardBuilder.prototype.createTableColumns = function (tableBody) {
        var header = this.domManipulator.createElement(tr, tableBody);
        this.domManipulator.createElement(th, header);
        for (var columnIndex = 0; columnIndex < 8; columnIndex++) {
            this.createTableHeaderCell(header, tc + columnIndex + 1, this.getColumnText(columnIndex));
        }
    };
    ChessBoardBuilder.prototype.createTableHeaderCell = function (parent, idValue, text) {
        var header = this.domManipulator.createElement(th, parent);
        header.setAttribute(id, idValue);
        header.textContent = text;
    };
    ChessBoardBuilder.prototype.createTableRank = function (tableBody, rankNumber) {
        var rank = this.domManipulator.createElement(tr, tableBody);
        this.createTableHeaderCell(rank, tr + rankNumber, rankNumber.toString());
        return rank;
    };
    ChessBoardBuilder.prototype.createSquares = function (tableBody) {
        for (var rankIndex = 0; rankIndex < 8; rankIndex++) {
            var rankNumber = this.whiteOnTopWhenShow ? rankIndex + 1 : 8 - rankIndex;
            var rank = this.createTableRank(tableBody, rankNumber);
            for (var columnIndex = 0; columnIndex < 8; columnIndex++) {
                var square = this.domManipulator.createElement(td, rank);
                square.setAttribute(id, this.getColumnText(columnIndex) + rankNumber);
                square.onclick = this.squareOnClick.bind(this);
                square.setAttribute('class', (rankIndex + columnIndex) % 2 == 1 ? 'dark' : 'light');
                square.textContent = this.isWhiteOnTopInStateRepresentation() ?
                    this.getState(rankNumber - 1, this.whiteOnTopWhenShow ? columnIndex : 7 - columnIndex) :
                    this.getState(this.whiteOnTopWhenShow ? 7 - rankIndex : rankIndex, this.whiteOnTopWhenShow ? 7 - columnIndex : columnIndex);
            }
        }
    };
    ChessBoardBuilder.prototype.squareOnClick = function (event) {
        if (this.moveFrom == null) {
            this.moveFrom = event.srcElement;
            this.moveFrom.classList.add(selected);
        }
        else {
            this.moveFrom.classList.remove(selected);
            var toSquare = this.getSquare(event.srcElement);
            var fromSquare = this.getSquare(this.moveFrom);
            this.move(this.getMove(fromSquare, toSquare));
            this.moveFrom = null;
        }
    };
    ChessBoardBuilder.prototype.move = function (move) {
        var _this = this;
        RequestSender.execute("KnightsTale/api/game/move/".concat(move), 'POST', new RequestCallbacksDto(function (knightsTaleDto) {
            _this.loadState(knightsTaleDto);
            if (knightsTaleDto.isWhiteTurn) {
                _this.chessGame.moveWhiteAI(true);
            }
            else {
                _this.chessGame.moveBlackAI(true);
            }
        }, function (request) { RequestSender.showError(request); }), "".concat(move, " executed."));
    };
    ChessBoardBuilder.prototype.getMove = function (fromSquare, toSquare) {
        return fromSquare.toString() + toSquare.toString();
    };
    ChessBoardBuilder.prototype.getSquare = function (square) {
        var rank = parseInt(square.id[1]);
        var column = square.id.charCodeAt(0);
        return this.isWhiteOnTopInStateRepresentation() ?
            new Square(column + a.charCodeAt(0), 8 - rank) :
            new Square(column - a.charCodeAt(0), 8 - rank);
    };
    ChessBoardBuilder.prototype.charShift = function (ch, shift) {
        return String.fromCharCode(ch.charCodeAt(0) + shift);
    };
    ChessBoardBuilder.prototype.getColumnText = function (columnIndex) {
        return this.whiteOnTopWhenShow ? this.charShift(h, -columnIndex) : this.charShift(a, columnIndex);
    };
    ChessBoardBuilder.prototype.isWhiteOnTopInStateRepresentation = function () {
        return InitialState[0][0] == '♖';
    };
    ChessBoardBuilder.prototype.getState = function (rankIndex, columnIndex) {
        return State[rankIndex][columnIndex];
    };
    ChessBoardBuilder.prototype.setState = function (rankIndex, columnIndex, value) {
        State[rankIndex][columnIndex] = value;
    };
    ChessBoardBuilder.prototype.resetStates = function () {
        for (var rankIndex = 0; rankIndex < 8; rankIndex++) {
            State[rankIndex] = InitialState[rankIndex].map(function (x) { return x; });
        }
    };
    ChessBoardBuilder.prototype.showChessBoard = function (whiteOnTopWhenShow) {
        if (whiteOnTopWhenShow === void 0) { whiteOnTopWhenShow = undefined; }
        if (whiteOnTopWhenShow !== undefined) {
            this.whiteOnTopWhenShow = whiteOnTopWhenShow;
        }
        var board = document.getElementsByTagName(table)[0];
        if (board) {
            board.remove();
            this.moveFrom = null;
        }
        this.createChessBoard();
    };
    ChessBoardBuilder.prototype.switchSide = function () {
        this.showChessBoard(!this.whiteOnTopWhenShow);
    };
    ChessBoardBuilder.prototype.loadState = function (knightsTaleDto) {
        for (var i = 0; i < knightsTaleDto.states.length; i++) {
            var rank = Math.floor(i / 8);
            var column = i % 8;
            this.setState(rank, column, knightsTaleDto.states[i]);
        }
        this.showChessBoard();
    };
    return ChessBoardBuilder;
}());
export { ChessBoardBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hlc3NCb2FyZEJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDaGVzc0JvYXJkQnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDcEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ25ELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFFckMsSUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQ2QsSUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDO0FBQ2QsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDO0FBQ3RCLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUNoQixJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDaEIsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLElBQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUNoQixJQUFNLEVBQUUsR0FBRyxJQUFJLENBQUM7QUFDaEIsSUFBTSxRQUFRLEdBQUcsVUFBVSxDQUFDO0FBRTVCLElBQU0sWUFBWSxHQUF5QjtJQUMxQyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0NBQ3hDLENBQUM7QUFFRixJQUFNLEtBQUssR0FBeUI7SUFDbkMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztJQUN4QyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUM7SUFDeEMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO0lBQ3hDLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQztDQUN4QyxDQUFDO0FBRUY7SUFPQywyQkFBbUIsU0FBb0I7UUFDdEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFDM0IsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxLQUFLLENBQUM7UUFDaEMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFTyw0Q0FBZ0IsR0FBeEI7UUFDQyxJQUFNLElBQUksR0FBZ0MsUUFBUSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ25GLElBQU0sS0FBSyxHQUErRCxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQWUsSUFBSSxDQUFDLENBQUM7UUFDdEksS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLFlBQVksQ0FBQyxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDNUMsSUFBTSxTQUFTLEdBQWdCLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBZSxLQUFLLENBQUMsQ0FBQztRQUU5RixJQUFJLENBQUMsa0JBQWtCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU8sOENBQWtCLEdBQTFCLFVBQTJCLFNBQXNCO1FBQ2hELElBQU0sTUFBTSxHQUFnQixJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFDN0UsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzlDLEtBQUssSUFBSSxXQUFXLEdBQUcsQ0FBQyxFQUFFLFdBQVcsR0FBRyxDQUFDLEVBQUUsV0FBVyxFQUFFLEVBQUU7WUFDekQsSUFBSSxDQUFDLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxFQUFFLEdBQUcsV0FBVyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7U0FDMUY7SUFDRixDQUFDO0lBRU8saURBQXFCLEdBQTdCLFVBQThCLE1BQW1CLEVBQUUsT0FBZSxFQUFFLElBQVk7UUFDL0UsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzdELE1BQU0sQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzNCLENBQUM7SUFFTywyQ0FBZSxHQUF2QixVQUF3QixTQUFzQixFQUFFLFVBQWtCO1FBQ2pFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxFQUFFLEVBQUUsR0FBRyxVQUFVLEVBQUUsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDekUsT0FBTyxJQUFJLENBQUM7SUFDYixDQUFDO0lBRU8seUNBQWEsR0FBckIsVUFBc0IsU0FBc0I7UUFDM0MsS0FBSyxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRTtZQUNuRCxJQUFNLFVBQVUsR0FBVyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUM7WUFDbkYsSUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsVUFBVSxDQUFDLENBQUM7WUFFekQsS0FBSyxJQUFJLFdBQVcsR0FBRyxDQUFDLEVBQUUsV0FBVyxHQUFHLENBQUMsRUFBRSxXQUFXLEVBQUUsRUFBRTtnQkFDekQsSUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxhQUFhLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO2dCQUMzRCxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxHQUFHLFVBQVUsQ0FBQyxDQUFDO2dCQUN0RSxNQUFNLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMvQyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDLFNBQVMsR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNwRixNQUFNLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxpQ0FBaUMsRUFBRSxDQUFDLENBQUM7b0JBQzlELElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLENBQUM7b0JBQ3hGLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQzthQUM3SDtTQUNEO0lBQ0YsQ0FBQztJQUVPLHlDQUFhLEdBQXJCLFVBQXNCLEtBQWlCO1FBQ3RDLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLEVBQUU7WUFDMUIsSUFBSSxDQUFDLFFBQVEsR0FBZ0IsS0FBSyxDQUFDLFVBQVUsQ0FBQztZQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDdEM7YUFBTTtZQUNOLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN6QyxJQUFNLFFBQVEsR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFjLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUN2RSxJQUFNLFVBQVUsR0FBVyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUN6RCxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDOUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7U0FDckI7SUFDRixDQUFDO0lBRU0sZ0NBQUksR0FBWCxVQUFZLElBQVk7UUFBeEIsaUJBV0k7UUFWSCxhQUFhLENBQUMsT0FBTyxDQUFDLG9DQUE2QixJQUFJLENBQUUsRUFBRSxNQUFNLEVBQ2hFLElBQUksbUJBQW1CLENBQUMsVUFBQyxjQUE4QjtZQUN0RCxLQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQy9CLElBQUksY0FBYyxDQUFDLFdBQVcsRUFBRTtnQkFDL0IsS0FBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDakM7aUJBQU07Z0JBQ04sS0FBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDckI7UUFFZCxDQUFDLEVBQUUsVUFBQyxPQUE2QixJQUFPLGFBQWEsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxVQUFHLElBQUksZUFBWSxDQUFDLENBQUM7SUFDbEcsQ0FBQztJQUVJLG1DQUFPLEdBQWYsVUFBZ0IsVUFBa0IsRUFBRSxRQUFnQjtRQUNuRCxPQUFPLFVBQVUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDcEQsQ0FBQztJQUVPLHFDQUFTLEdBQWpCLFVBQWtCLE1BQW1CO1FBQ3BDLElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBUyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUMsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDeEMsT0FBTyxJQUFJLENBQUMsaUNBQWlDLEVBQUUsQ0FBQyxDQUFDO1lBQ2hELElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ2hELElBQUksTUFBTSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBRU8scUNBQVMsR0FBakIsVUFBa0IsRUFBVSxFQUFFLEtBQWE7UUFDMUMsT0FBTyxNQUFNLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVPLHlDQUFhLEdBQXJCLFVBQXNCLFdBQW1CO1FBQ3hDLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNuRyxDQUFDO0lBRU8sNkRBQWlDLEdBQXpDO1FBQ0MsT0FBdUIsWUFBWSxDQUFDLENBQUMsQ0FBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQztJQUNuRCxDQUFDO0lBRU8sb0NBQVEsR0FBaEIsVUFBaUIsU0FBaUIsRUFBRSxXQUFtQjtRQUN0RCxPQUErQixLQUFLLENBQUMsU0FBUyxDQUFFLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDL0QsQ0FBQztJQUVPLG9DQUFRLEdBQWhCLFVBQWlCLFNBQWlCLEVBQUUsV0FBbUIsRUFBRSxLQUFhO1FBQ3JELEtBQUssQ0FBQyxTQUFTLENBQUUsQ0FBQyxXQUFXLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDeEQsQ0FBQztJQUVNLHVDQUFXLEdBQWxCO1FBQ0MsS0FBSyxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQUUsU0FBUyxHQUFHLENBQUMsRUFBRSxTQUFTLEVBQUUsRUFBRTtZQUNuRCxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQW1CLFlBQVksQ0FBQyxTQUFTLENBQUUsQ0FBQyxHQUFHLENBQUMsVUFBQyxDQUFTLElBQUssT0FBQSxDQUFDLEVBQUQsQ0FBQyxDQUFDLENBQUM7U0FDbEY7SUFDRixDQUFDO0lBRU0sMENBQWMsR0FBckIsVUFBc0Isa0JBQW1EO1FBQW5ELG1DQUFBLEVBQUEsOEJBQW1EO1FBQ3hFLElBQUksa0JBQWtCLEtBQUssU0FBUyxFQUFFO1lBQ3JDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxrQkFBa0IsQ0FBQztTQUN2QztRQUVQLElBQU0sS0FBSyxHQUFpQyxRQUFRLENBQUMsb0JBQW9CLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDcEYsSUFBSSxLQUFLLEVBQUU7WUFDVixLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDZixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztTQUNyQjtRQUNELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFTSxzQ0FBVSxHQUFqQjtRQUNDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU0scUNBQVMsR0FBaEIsVUFBaUIsY0FBOEI7UUFDOUMsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ3RELElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQy9CLElBQU0sTUFBTSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFVLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUM5RDtRQUNELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUNwQixDQUFDO0lBQ0wsd0JBQUM7QUFBRCxDQUFDLEFBdkpELElBdUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDaGVzc0dhbWUgfSBmcm9tICcuL0NoZXNzR2FtZS5qcyc7XHJcbmltcG9ydCB7IERvbU1hbmlwdWxhdG9yIH0gZnJvbSAnLi9Eb21NYW5pcHVsYXRvci5qcyc7XHJcbmltcG9ydCB0eXBlIHsgS25pZ2h0c1RhbGVEdG8gfSBmcm9tICcuL0R0b3MvS25pZ2h0c1RhbGVEdG8uanMnO1xyXG5pbXBvcnQgeyBSZXF1ZXN0Q2FsbGJhY2tzRHRvIH0gZnJvbSAnLi9EdG9zL1JlcXVlc3RDYWxsYmFja3NEdG8uanMnO1xyXG5pbXBvcnQgeyBSZXF1ZXN0U2VuZGVyIH0gZnJvbSAnLi9SZXF1ZXN0U2VuZGVyLmpzJztcclxuaW1wb3J0IHsgU3F1YXJlIH0gZnJvbSAnLi9TcXVhcmUuanMnO1xyXG5cclxuY29uc3QgYSA9ICdBJztcclxuY29uc3QgaCA9ICdIJztcclxuY29uc3QgdGFibGUgPSAndGFibGUnO1xyXG5jb25zdCB0aCA9ICd0aCc7XHJcbmNvbnN0IHRyID0gJ3RyJztcclxuY29uc3QgdGQgPSAndGQnO1xyXG5jb25zdCB0YyA9ICd0Yyc7XHJcbmNvbnN0IGlkID0gJ2lkJztcclxuY29uc3Qgc2VsZWN0ZWQgPSAnc2VsZWN0ZWQnO1xyXG5cclxuY29uc3QgSW5pdGlhbFN0YXRlOiBBcnJheTxBcnJheTxzdHJpbmc+PiA9IFtcclxuXHRbJ+KZnCcsICfimZ4nLCAn4pmdJywgJ+KZmycsICfimZonLCAn4pmdJywgJ+KZnicsICfimZwnXSxcclxuXHRbJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJ10sXHJcblx0WycgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmSddLFxyXG5cdFsn4pmWJywgJ+KZmCcsICfimZcnLCAn4pmVJywgJ+KZlCcsICfimZcnLCAn4pmYJywgJ+KZliddXHJcbl07XHJcblxyXG5jb25zdCBTdGF0ZTogQXJyYXk8QXJyYXk8c3RyaW5nPj4gPSBbXHJcblx0WyfimZwnLCAn4pmeJywgJ+KZnScsICfimZsnLCAn4pmaJywgJ+KZnScsICfimZ4nLCAn4pmcJ10sXHJcblx0WyfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJywgJ+KZnycsICfimZ8nLCAn4pmfJ10sXHJcblx0WycgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnXSxcclxuXHRbJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICddLFxyXG5cdFsnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJ10sXHJcblx0WycgJywgJyAnLCAnICcsICcgJywgJyAnLCAnICcsICcgJywgJyAnXSxcclxuXHRbJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmScsICfimZknLCAn4pmZJywgJ+KZmScsICfimZknXSxcclxuXHRbJ+KZlicsICfimZgnLCAn4pmXJywgJ+KZlScsICfimZQnLCAn4pmXJywgJ+KZmCcsICfimZYnXVxyXG5dO1xyXG5cclxuZXhwb3J0IGNsYXNzIENoZXNzQm9hcmRCdWlsZGVyIHtcclxuXHJcblx0cHJpdmF0ZSBkb21NYW5pcHVsYXRvcjogRG9tTWFuaXB1bGF0b3I7XHJcblx0cHJpdmF0ZSBtb3ZlRnJvbTogSFRNTEVsZW1lbnQgfCBudWxsO1xyXG5cdHByaXZhdGUgd2hpdGVPblRvcFdoZW5TaG93OiBib29sZWFuO1xyXG5cdHByaXZhdGUgY2hlc3NHYW1lOiBDaGVzc0dhbWU7XHJcblxyXG5cdHB1YmxpYyBjb25zdHJ1Y3RvcihjaGVzc0dhbWU6IENoZXNzR2FtZSkge1xyXG5cdFx0dGhpcy5jaGVzc0dhbWUgPSBjaGVzc0dhbWU7XHJcblx0XHR0aGlzLmRvbU1hbmlwdWxhdG9yID0gbmV3IERvbU1hbmlwdWxhdG9yKCk7XHJcblx0XHR0aGlzLm1vdmVGcm9tID0gbnVsbDtcclxuXHRcdHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID0gZmFsc2U7XHJcblx0XHR0aGlzLnNob3dDaGVzc0JvYXJkKCk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGNyZWF0ZUNoZXNzQm9hcmQoKTogdm9pZCB7XHJcblx0XHRjb25zdCBib2R5OiBIVE1MQm9keUVsZW1lbnQgfCB1bmRlZmluZWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdO1xyXG5cdFx0Y29uc3QgYm9hcmQ6IEhUTUxUYWJsZUVsZW1lbnQgfCB1bmRlZmluZWQgPSA8SFRNTFRhYmxlRWxlbWVudCB8IHVuZGVmaW5lZD50aGlzLmRvbU1hbmlwdWxhdG9yLmNyZWF0ZUVsZW1lbnQodGFibGUsIDxIVE1MRWxlbWVudD5ib2R5KTtcclxuXHRcdGJvYXJkPy5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgJ2NoZXNzLWJvYXJkJyk7XHJcblx0XHRjb25zdCB0YWJsZUJvZHk6IEhUTUxFbGVtZW50ID0gdGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KCd0Ym9keScsIDxIVE1MRWxlbWVudD5ib2FyZCk7XHJcblxyXG5cdFx0dGhpcy5jcmVhdGVUYWJsZUNvbHVtbnModGFibGVCb2R5KTtcclxuXHRcdHRoaXMuY3JlYXRlU3F1YXJlcyh0YWJsZUJvZHkpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBjcmVhdGVUYWJsZUNvbHVtbnModGFibGVCb2R5OiBIVE1MRWxlbWVudCk6IHZvaWQge1xyXG5cdFx0Y29uc3QgaGVhZGVyOiBIVE1MRWxlbWVudCA9IHRoaXMuZG9tTWFuaXB1bGF0b3IuY3JlYXRlRWxlbWVudCh0ciwgdGFibGVCb2R5KTtcclxuXHRcdHRoaXMuZG9tTWFuaXB1bGF0b3IuY3JlYXRlRWxlbWVudCh0aCwgaGVhZGVyKTtcdFxyXG5cdFx0Zm9yIChsZXQgY29sdW1uSW5kZXggPSAwOyBjb2x1bW5JbmRleCA8IDg7IGNvbHVtbkluZGV4KyspIHtcclxuXHRcdFx0dGhpcy5jcmVhdGVUYWJsZUhlYWRlckNlbGwoaGVhZGVyLCB0YyArIGNvbHVtbkluZGV4ICsgMSwgdGhpcy5nZXRDb2x1bW5UZXh0KGNvbHVtbkluZGV4KSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGNyZWF0ZVRhYmxlSGVhZGVyQ2VsbChwYXJlbnQ6IEhUTUxFbGVtZW50LCBpZFZhbHVlOiBzdHJpbmcsIHRleHQ6IHN0cmluZyk6IHZvaWQge1xyXG5cdFx0Y29uc3QgaGVhZGVyID0gdGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KHRoLCBwYXJlbnQpO1xyXG5cdFx0aGVhZGVyLnNldEF0dHJpYnV0ZShpZCwgaWRWYWx1ZSk7XHJcblx0XHRoZWFkZXIudGV4dENvbnRlbnQgPSB0ZXh0O1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBjcmVhdGVUYWJsZVJhbmsodGFibGVCb2R5OiBIVE1MRWxlbWVudCwgcmFua051bWJlcjogbnVtYmVyKSB7XHJcblx0XHRjb25zdCByYW5rID0gdGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KHRyLCB0YWJsZUJvZHkpO1xyXG5cdFx0dGhpcy5jcmVhdGVUYWJsZUhlYWRlckNlbGwocmFuaywgdHIgKyByYW5rTnVtYmVyLCByYW5rTnVtYmVyLnRvU3RyaW5nKCkpO1xyXG5cdFx0cmV0dXJuIHJhbms7XHJcblx0fVxyXG5cdFxyXG5cdHByaXZhdGUgY3JlYXRlU3F1YXJlcyh0YWJsZUJvZHk6IEhUTUxFbGVtZW50KSB7XHJcblx0XHRmb3IgKGxldCByYW5rSW5kZXggPSAwOyByYW5rSW5kZXggPCA4OyByYW5rSW5kZXgrKykge1xyXG5cdFx0XHRjb25zdCByYW5rTnVtYmVyOiBudW1iZXIgPSB0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyA/IHJhbmtJbmRleCArIDEgOiA4IC0gcmFua0luZGV4O1xyXG5cdFx0XHRjb25zdCByYW5rID0gdGhpcy5jcmVhdGVUYWJsZVJhbmsodGFibGVCb2R5LCByYW5rTnVtYmVyKTtcclxuXHRcdFx0XHJcblx0XHRcdGZvciAobGV0IGNvbHVtbkluZGV4ID0gMDsgY29sdW1uSW5kZXggPCA4OyBjb2x1bW5JbmRleCsrKSB7XHJcblx0XHRcdFx0Y29uc3Qgc3F1YXJlID0gdGhpcy5kb21NYW5pcHVsYXRvci5jcmVhdGVFbGVtZW50KHRkLCByYW5rKTtcclxuXHRcdFx0XHRzcXVhcmUuc2V0QXR0cmlidXRlKGlkLCB0aGlzLmdldENvbHVtblRleHQoY29sdW1uSW5kZXgpICsgcmFua051bWJlcik7XHJcblx0XHRcdFx0c3F1YXJlLm9uY2xpY2sgPSB0aGlzLnNxdWFyZU9uQ2xpY2suYmluZCh0aGlzKTtcclxuXHRcdFx0XHRzcXVhcmUuc2V0QXR0cmlidXRlKCdjbGFzcycsIChyYW5rSW5kZXggKyBjb2x1bW5JbmRleCkgJSAyID09IDEgPyAnZGFyaycgOiAnbGlnaHQnKTtcclxuXHRcdFx0XHRzcXVhcmUudGV4dENvbnRlbnQgPSB0aGlzLmlzV2hpdGVPblRvcEluU3RhdGVSZXByZXNlbnRhdGlvbigpID9cclxuXHRcdFx0XHRcdHRoaXMuZ2V0U3RhdGUocmFua051bWJlciAtIDEsIHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID8gY29sdW1uSW5kZXggOiA3IC0gY29sdW1uSW5kZXgpIDpcclxuXHRcdFx0XHRcdHRoaXMuZ2V0U3RhdGUodGhpcy53aGl0ZU9uVG9wV2hlblNob3cgPyA3IC0gcmFua0luZGV4IDogcmFua0luZGV4LCB0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyA/IDcgLSBjb2x1bW5JbmRleCA6IGNvbHVtbkluZGV4KTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzcXVhcmVPbkNsaWNrKGV2ZW50OiBNb3VzZUV2ZW50KSB7XHJcblx0XHRpZiAodGhpcy5tb3ZlRnJvbSA9PSBudWxsKSB7XHJcblx0XHRcdHRoaXMubW92ZUZyb20gPSA8SFRNTEVsZW1lbnQ+ZXZlbnQuc3JjRWxlbWVudDtcclxuXHRcdFx0dGhpcy5tb3ZlRnJvbS5jbGFzc0xpc3QuYWRkKHNlbGVjdGVkKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdHRoaXMubW92ZUZyb20uY2xhc3NMaXN0LnJlbW92ZShzZWxlY3RlZCk7XHJcblx0XHRcdGNvbnN0IHRvU3F1YXJlOiBTcXVhcmUgPSB0aGlzLmdldFNxdWFyZSg8SFRNTEVsZW1lbnQ+ZXZlbnQuc3JjRWxlbWVudCk7XHJcblx0XHRcdGNvbnN0IGZyb21TcXVhcmU6IFNxdWFyZSA9IHRoaXMuZ2V0U3F1YXJlKHRoaXMubW92ZUZyb20pO1xyXG5cdFx0XHR0aGlzLm1vdmUodGhpcy5nZXRNb3ZlKGZyb21TcXVhcmUsIHRvU3F1YXJlKSk7XHJcblx0XHRcdHRoaXMubW92ZUZyb20gPSBudWxsO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHVibGljIG1vdmUobW92ZTogc3RyaW5nKTogdm9pZCB7XHJcblx0XHRSZXF1ZXN0U2VuZGVyLmV4ZWN1dGUoYEtuaWdodHNUYWxlL2FwaS9nYW1lL21vdmUvJHttb3ZlfWAsICdQT1NUJyxcclxuXHRcdFx0bmV3IFJlcXVlc3RDYWxsYmFja3NEdG8oKGtuaWdodHNUYWxlRHRvOiBLbmlnaHRzVGFsZUR0bykgPT4ge1xyXG5cdFx0XHRcdHRoaXMubG9hZFN0YXRlKGtuaWdodHNUYWxlRHRvKTtcclxuXHRcdFx0XHRpZiAoa25pZ2h0c1RhbGVEdG8uaXNXaGl0ZVR1cm4pIHtcclxuXHRcdFx0XHRcdHRoaXMuY2hlc3NHYW1lLm1vdmVXaGl0ZUFJKHRydWUpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHR0aGlzLmNoZXNzR2FtZS5tb3ZlQmxhY2tBSSh0cnVlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHRcdFx0XHRcclxuXHRcdFx0fSwgKHJlcXVlc3Q6IEpRdWVyeS5qcVhIUjxvYmplY3Q+KSA9PiB7IFJlcXVlc3RTZW5kZXIuc2hvd0Vycm9yKHJlcXVlc3QpOyB9KSwgYCR7bW92ZX0gZXhlY3V0ZWQuYCk7XHJcbiAgICB9XHJcblxyXG5cdHByaXZhdGUgZ2V0TW92ZShmcm9tU3F1YXJlOiBTcXVhcmUsIHRvU3F1YXJlOiBTcXVhcmUpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIGZyb21TcXVhcmUudG9TdHJpbmcoKSArIHRvU3F1YXJlLnRvU3RyaW5nKCk7XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGdldFNxdWFyZShzcXVhcmU6IEhUTUxFbGVtZW50KTogU3F1YXJlIHtcclxuXHRcdGNvbnN0IHJhbmsgPSBwYXJzZUludCg8c3RyaW5nPnNxdWFyZS5pZFsxXSk7XHJcblx0XHRjb25zdCBjb2x1bW4gPSBzcXVhcmUgLmlkLmNoYXJDb2RlQXQoMCk7XHJcblx0XHRyZXR1cm4gdGhpcy5pc1doaXRlT25Ub3BJblN0YXRlUmVwcmVzZW50YXRpb24oKSA/XHJcblx0XHRcdG5ldyBTcXVhcmUoY29sdW1uICsgYS5jaGFyQ29kZUF0KDApLCA4IC0gcmFuaykgOlxyXG5cdFx0XHRuZXcgU3F1YXJlKGNvbHVtbiAtIGEuY2hhckNvZGVBdCgwKSwgOCAtIHJhbmspO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBjaGFyU2hpZnQoY2g6IHN0cmluZywgc2hpZnQ6IG51bWJlcik6IHN0cmluZyB7XHJcblx0XHRyZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShjaC5jaGFyQ29kZUF0KDApICsgc2hpZnQpO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRDb2x1bW5UZXh0KGNvbHVtbkluZGV4OiBudW1iZXIpOiBzdHJpbmcge1xyXG5cdFx0cmV0dXJuIHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID8gdGhpcy5jaGFyU2hpZnQoaCwgLWNvbHVtbkluZGV4KSA6IHRoaXMuY2hhclNoaWZ0KGEsIGNvbHVtbkluZGV4KTtcclxuXHR9XHJcblxyXG5cdHByaXZhdGUgaXNXaGl0ZU9uVG9wSW5TdGF0ZVJlcHJlc2VudGF0aW9uKCk6IGJvb2xlYW4ge1xyXG5cdFx0cmV0dXJuICg8QXJyYXk8c3RyaW5nPj5Jbml0aWFsU3RhdGVbMF0pWzBdID09ICfimZYnO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRTdGF0ZShyYW5rSW5kZXg6IG51bWJlciwgY29sdW1uSW5kZXg6IG51bWJlcik6IHN0cmluZyB7XHJcblx0XHRyZXR1cm4gPHN0cmluZz4oPEFycmF5PHN0cmluZz4+U3RhdGVbcmFua0luZGV4XSlbY29sdW1uSW5kZXhdO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBzZXRTdGF0ZShyYW5rSW5kZXg6IG51bWJlciwgY29sdW1uSW5kZXg6IG51bWJlciwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xyXG5cdFx0KDxBcnJheTxzdHJpbmc+PlN0YXRlW3JhbmtJbmRleF0pW2NvbHVtbkluZGV4XSA9IHZhbHVlO1xyXG5cdH1cclxuXHJcblx0cHVibGljIHJlc2V0U3RhdGVzKCk6IHZvaWQge1xyXG5cdFx0Zm9yIChsZXQgcmFua0luZGV4ID0gMDsgcmFua0luZGV4IDwgODsgcmFua0luZGV4KyspIHtcclxuXHRcdFx0U3RhdGVbcmFua0luZGV4XSA9ICg8QXJyYXk8c3RyaW5nPj5Jbml0aWFsU3RhdGVbcmFua0luZGV4XSkubWFwKCh4OiBzdHJpbmcpID0+IHgpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cHVibGljIHNob3dDaGVzc0JvYXJkKHdoaXRlT25Ub3BXaGVuU2hvdzogYm9vbGVhbiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZCk6IHZvaWQge1xyXG5cdFx0aWYgKHdoaXRlT25Ub3BXaGVuU2hvdyAhPT0gdW5kZWZpbmVkKSB7XHJcblx0XHRcdHRoaXMud2hpdGVPblRvcFdoZW5TaG93ID0gd2hpdGVPblRvcFdoZW5TaG93O1xyXG4gICAgICAgIH1cclxuXHJcblx0XHRjb25zdCBib2FyZDogSFRNTFRhYmxlRWxlbWVudCB8IHVuZGVmaW5lZCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhYmxlKVswXTtcclxuXHRcdGlmIChib2FyZCkge1xyXG5cdFx0XHRib2FyZC5yZW1vdmUoKTtcclxuXHRcdFx0dGhpcy5tb3ZlRnJvbSA9IG51bGw7XHJcblx0XHR9XHJcblx0XHR0aGlzLmNyZWF0ZUNoZXNzQm9hcmQoKTtcclxuXHR9XHJcblx0XHJcblx0cHVibGljIHN3aXRjaFNpZGUoKTogdm9pZCB7XHJcblx0XHR0aGlzLnNob3dDaGVzc0JvYXJkKCF0aGlzLndoaXRlT25Ub3BXaGVuU2hvdyk7XHJcblx0fVxyXG5cclxuXHRwdWJsaWMgbG9hZFN0YXRlKGtuaWdodHNUYWxlRHRvOiBLbmlnaHRzVGFsZUR0byk6IHZvaWQge1xyXG5cdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBrbmlnaHRzVGFsZUR0by5zdGF0ZXMubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0Y29uc3QgcmFuayA9IE1hdGguZmxvb3IoaSAvIDgpO1xyXG5cdFx0XHRjb25zdCBjb2x1bW4gPSBpICUgODtcclxuXHRcdFx0dGhpcy5zZXRTdGF0ZShyYW5rLCBjb2x1bW4sIDxzdHJpbmc+a25pZ2h0c1RhbGVEdG8uc3RhdGVzW2ldKTtcclxuXHRcdH1cclxuXHRcdHRoaXMuc2hvd0NoZXNzQm9hcmQoKTtcclxuICAgIH1cclxufSJdfQ==